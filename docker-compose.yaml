# SPDX-License-Identifier: BSD-2-Clause
# Copyright  (c) 2020-2023, The Chancellor, Masters and Scholars of the University
# of Oxford, and the 'Galv' Developers. All rights reserved.

# This docker-compose setup is for local dev purposes only.
# Its role is to connect the backend to a postgres database.

version: "3.8"

services:
  app:
    image: app
    build:
      dockerfile: Dockerfile
      context: .
    depends_on:
      - postgres
    volumes:
      - ./.dev/.static_files:/static
      - ./backend_django:/usr/app/backend_django
      - ./.dev/spec:/spec
    working_dir: /usr/app
    environment:
      VIRTUAL_HOST: "localhost"
      FRONTEND_VIRTUAL_HOST: "http://${VIRTUAL_HOST_ROOT},https://${VIRTUAL_HOST_ROOT}"
      DJANGO_SETTINGS: "dev"
      DJANGO_SUPERUSER_PASSWORD: "admin"
    env_file:
      - ./.env
    restart: unless-stopped
    ports:
      - "8001:80"
    command: ./server.sh

  postgres:
    image: "postgres:14"
    stop_signal: SIGINT                 # Fast Shutdown mode
    volumes:
      - "./.dev/data:/var/lib/postgresql/data"
    environment:
      # variables listed as defaults in backend_django/config/settings_dev.py
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "galv"
      POSTGRES_PORT: "5432"
    restart: unless-stopped

  app_test:
    image: app-test
    build:
      dockerfile: Dockerfile-test
      context: .
    depends_on:
      - postgres
    volumes:
      - ./.test/.static_files:/static
      - ./backend_django:/usr/app/backend_django
    working_dir: /usr/app
    environment:
      FRONTEND_VIRTUAL_HOST: "http://localhost"
      VIRTUAL_HOST: "localhost"
      VIRTUAL_HOST_ROOT: "localhost"
      DJANGO_SETTINGS: "dev"
    env_file:
      - ./.env
    restart: "on-failure"
    command: ./server.sh

  check_spec:
    image: openapitools/openapi-diff
    volumes:
      - ./.dev/spec:/spec
    entrypoint: /bin/sh -c
    environment:
      REMOTE_SPEC_URL: "https://github.com/Battery-Intelligence-Lab/galv-spec/releases/latest/download/galv-spec.json"
    command: ["java -jar /app/openapi-diff.jar --fail-on-incompatible --markdown /spec/diff.md $${REMOTE_SPEC_URL} $$(ls /spec/openapi-*.json | tail -n 1)"]
    depends_on:
      - app  # app has to run for the spec to be generated
